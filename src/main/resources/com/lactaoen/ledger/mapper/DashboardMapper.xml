<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="DashboardMapper">

    <resultMap id="CategoryExpenseMapper" type="com.lactaoen.ledger.model.dashboard.CategoryExpenseMapper">
        <id property="categoryId" column="category_id" />
        <result property="parentCategoryName" column="parent_category_name" />
        <result property="categoryName" column="category_name" />
        <result property="transactionCount" column="transaction_count" />
        <result property="total" column="total" />
        <result property="averageSpent" column="average_spent" />
    </resultMap>

    <select id="getCategoryExpensesByYear" resultMap="CategoryExpenseMapper">
        SELECT
            c.category_id,
            pc.name AS parent_category_name,
            c.name AS category_name,
            COUNT(t.transaction_id) AS transaction_count,
            COALESCE(ROUND(SUM(t.price), 2), 0) AS total,
            COALESCE(ROUND(AVG(t.price), 2), 0) AS average_spent
        FROM category c
        JOIN category pc ON c.parent_id = pc.category_id
        LEFT JOIN `transaction` t ON c.category_id = t.category_id AND YEAR(t.date) = #{id}
        WHERE c.parent_id IS NOT NULL
        GROUP BY c.category_id
        ORDER BY c.parent_id, c.category_id
    </select>

</mapper>