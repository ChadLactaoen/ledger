<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BetMapper">

    <resultMap id="Bet" type="com.lactaoen.ledger.model.Bet">
        <id property="betId" column="bet_id" />
        <result property="date" column="date" />
        <result property="memo" column="memo" />
        <result property="wager" column="wager" />
        <result property="profit" column="profit" />
        <association property="game" column="game_id" select="GameMapper.getGameById" />
        <association property="casino" column="casino_id" select="CasinoMapper.getCasinoById" />
        <association property="sportsBet" column="bet_id" select="SportsBetMapper.getSportsBetByBetId" />
    </resultMap>

    <resultMap id="GraphCoordinate" type="com.lactaoen.ledger.model.GraphCoordinate">
        <id property="x" column="x" />
        <result property="y" column="y" />
    </resultMap>

    <select id="getAllBets" resultMap="Bet">
        SELECT /* BetMapper.getAllBets */
            bet_id, date, game_id, casino_id, wager, profit, memo
        FROM bet
    </select>

    <select id="getAllBetsByYear" resultMap="Bet">
        SELECT /* BetMapper.getAllBetsByYear */
            bet_id, date, game_id, casino_id, wager, profit, memo
        FROM bet
        WHERE YEAR(date) = #{id}
    </select>

    <select id="getBetById" resultMap="Bet">
        SELECT /* BetMapper.getBetById */
            bet_id, date, game_id, casino_id, wager, profit, memo
        FROM bet
        WHERE bet_id = #{id}
    </select>

    <select id="getUnresolvedBets" resultMap="Bet">
        SELECT /* BetMapper.getUnresolvedSportsBets */
            bet_id, date, game_id, casino_id, wager, profit, memo
        FROM bet
        WHERE profit IS NULL
        ORDER BY date
    </select>

    <select id="getBetDataPointsByYear" resultMap="GraphCoordinate">
        SELECT /* BetMapper.getBetDataPointsByYear */
            WEEKOFYEAR(date) AS x, SUM(profit) AS y
        FROM bet
        WHERE profit IS NOT NULL
        AND YEAR(date) = #{id}
        GROUP BY WEEKOFYEAR(date)
        ORDER BY x
    </select>

    <select id="getCurrentWeekOfYear" resultType="Integer">
        SELECT WEEKOFYEAR(CURDATE());
    </select>

    <select id="getBetDataPointsByYearAndGame" resultMap="GraphCoordinate">
        SELECT /* BetMapper.getBetDataPointsByYearAndGame */
            WEEKOFYEAR(date) AS x, SUM(profit) AS y
        FROM bet b
        JOIN game g ON b.game_id = g.game_id
        JOIN game pg ON g.parent_id = pg.game_id
        WHERE profit IS NOT NULL
        AND YEAR(date) = #{year}
        AND pg.name = #{name}
        GROUP BY WEEKOFYEAR(date)
        ORDER BY x
    </select>

    <insert id="createBet" useGeneratedKeys="true" keyProperty="betId">
        INSERT INTO /* BetMapper.createBet */
            bet
        (date, memo, wager, profit, game_id, casino_id)
        VALUES (
            #{date},
            #{memo},
            #{wager},
            #{profit},
            #{gameId},
            #{casinoId}
        )
    </insert>

    <update id="updateBet">
        UPDATE /* BetMapper.updateBet */
            bet
        SET
            date = #{date},
            memo = #{memo},
            wager = #{wager},
            profit = #{profit},
            game_id = #{gameId},
            casino_id = #{casinoId}
        WHERE bet_id = #{betId}
    </update>

    <delete id="deleteBet">
        DELETE FROM /* BetMapper.deleteBet */
            bet
        WHERE bet_id = #{id}
    </delete>

</mapper>